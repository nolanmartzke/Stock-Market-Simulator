stages:
  - lint
  - test

# Only try to normalize/make executable the gradle wrapper if it exists in backend/
before_script:
  - |
    if [ -f backend/gradlew ]; then
      command -v dos2unix >/dev/null && dos2unix backend/gradlew || true
      chmod +x backend/gradlew || true
    fi

# Frontend
lint_frontend:
  stage: lint
  image: node:18-bullseye
  tags:
    - csl
  script:
    - cd frontend
    - npm ci --prefer-offline --no-audit --progress=false
    - npm run lint
  only:
    - branches

# Backend
lint_backend:
  stage: lint
  image: eclipse-temurin:21-jdk
  tags:
    - csl
  script:
    - cd backend
    - chmod +x ./gradlew || true
    - ./gradlew checkstyleMain
  artifacts:
    paths:
      - backend/build/reports/checkstyle/
    when: always
    expire_in: 7 days
  only:
    - branches

# Run backend unit tests and collect JUnit reports
test_backend:
  stage: test
  image: eclipse-temurin:21-jdk
  tags:
    - csl
  script:
    - cd backend
    - chmod +x ./gradlew || true
    - ./gradlew clean test --no-daemon
  artifacts:
    when: always
    expire_in: 7 days
    paths:
      - backend/build/test-results/test
      - backend/build/reports/tests/test
  only:
    - branches
    - merge_requests
